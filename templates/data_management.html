{% extends "base.html" %}

{% block title %}æ•°æ®ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“‚ æ•°æ®é›†ç®¡ç†</h2>
    <p style="color:#666;">æ‚¨å¯ä»¥åœ¨æ­¤ä¸Šä¼ æ–°çš„å¤±æ•ˆæ—¶é—´æ•°æ®ï¼Œæˆ–ç®¡ç†å·²æœ‰çš„æ•°æ®æ–‡ä»¶ã€‚</p>
    
    <div style="margin-top: 20px; padding: 20px; border: 2px dashed #1890ff; border-radius: 8px; text-align: center; background: #f0f9ff;">
        <input type="file" id="fileInput" accept=".txt,.csv,.xls,.xlsx" style="display: none;" onchange="handleFileSelect()">
        <button onclick="document.getElementById('fileInput').click()" style="font-size: 16px; padding: 8px 20px;">+ ç‚¹å‡»ä¸Šä¼ æ–°æ•°æ®</button>
        <p id="fileNameDisplay" style="margin-top: 10px; color: #666;">æ”¯æŒ .txtã€.csvã€.xlsã€.xlsx æ–‡ä»¶ï¼ˆè‡ªåŠ¨æå–å•å…ƒæ ¼ä¸­çš„æ•°å€¼ä½œä¸ºæ—¶é—´åºåˆ—ï¼‰</p>
        <button id="uploadBtn" onclick="uploadFile()" style="display: none; background-color: #52c41a; margin-top: 10px;">ç¡®è®¤ä¸Šä¼ </button>
    </div>
</div>

<div class="card" style="margin-top: 24px;">
    <h3>æˆ‘çš„æ•°æ®é›†</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background: #fafafa; border-bottom: 2px solid #eee; text-align: left;">
                <th style="padding: 12px;">ID</th>
                <th style="padding: 12px;">æ–‡ä»¶å</th>
                <th style="padding: 12px;">æ•°æ®é‡</th>
                <th style="padding: 12px;">ä¸Šä¼ æ—¶é—´</th>
                <th style="padding: 12px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="dataset-list">
            </tbody>
    </table>
</div>

<script>
    // é¡µé¢åŠ è½½æ—¶è·å–åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', loadList);

    function handleFileSelect() {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            document.getElementById('fileNameDisplay').innerText = `å·²é€‰æ–‡ä»¶: ${file.name}`;
            document.getElementById('uploadBtn').style.display = 'inline-block';
        }
    }

    function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/data/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('ä¸Šä¼ æˆåŠŸï¼');
                document.getElementById('fileInput').value = '';
                document.getElementById('fileNameDisplay').innerText = '';
                document.getElementById('uploadBtn').style.display = 'none';
                loadList(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
            }
        })
        .catch(err => alert('ç½‘ç»œé”™è¯¯'));
    }

    function loadList() {
        fetch('/api/data/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('dataset-list');
                tbody.innerHTML = '';
                data.data.forEach(item => {
                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;">${item.id}</td>
                            <td style="padding: 12px;"><strong>${item.name}</strong></td>
                            <td style="padding: 12px;">${item.count} ä¸ªç‚¹</td>
                            <td style="padding: 12px; color: #888;">${item.time}</td>
                            <td style="padding: 12px;">
                                <button onclick="viewDataset(${item.id}, '${item.name}')" style="background-color: #1890ff; padding: 4px 12px; font-size: 12px; margin-right: 5px;">æŸ¥çœ‹æ•°æ®</button>
                                <button onclick="deleteDataset(${item.id})" style="background-color: #ff4d4f; padding: 4px 12px; font-size: 12px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: #999;">æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ </td></tr>';
                }
            }
        });
    }

    function deleteDataset(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•°æ®é›†å—ï¼Ÿ')) return;
        fetch(`/api/data/delete/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) loadList();
            else alert(data.error);
        });
    }

    // æŸ¥çœ‹æ•°æ®åŠŸèƒ½
    const dataModal = document.createElement('div');
    dataModal.id = 'dataModal';
    dataModal.style.cssText = `
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    `;
    dataModal.innerHTML = `
        <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); position: relative;">
            <span style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="document.getElementById('dataModal').style.display='none';">&times;</span>
            <h3 id="dataModalTitle" style="color: var(--primary-color); margin-bottom: 15px;">æ•°æ®é›†å†…å®¹</h3>
            <pre id="dataModalContent" style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
    `;
    document.body.appendChild(dataModal);

    function viewDataset(id, name) {
        document.getElementById('dataModalTitle').innerText = `æ•°æ®é›†å†…å®¹: ${name}`;
        document.getElementById('dataModalContent').innerText = 'åŠ è½½ä¸­...';
        document.getElementById('dataModal').style.display = 'block';

        fetch(`/api/data/get/${id}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // æ ¼å¼åŒ–æ•°æ®ï¼Œæ¯10ä¸ªæ•°å­—ä¸€è¡Œ
                let formattedData = '';
                for (let i = 0; i < data.data.length; i++) {
                    formattedData += data.data[i].toFixed(2); // ä¿ç•™ä¸¤ä½å°æ•°
                    if ((i + 1) % 10 === 0) {
                        formattedData += '\n';
                    } else if (i < data.data.length - 1) {
                        formattedData += ', ';
                    }
                }
                document.getElementById('dataModalContent').innerText = formattedData;
            } else {
                document.getElementById('dataModalContent').innerText = 'åŠ è½½å¤±è´¥: ' + data.error;
            }
        })
        .catch(err => {
            document.getElementById('dataModalContent').innerText = 'ç½‘ç»œé”™è¯¯: ' + err;
        });
    }
</script>
{% endblock %}
