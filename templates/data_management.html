{% extends "base.html" %}

{% block title %}æ•°æ®ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“‚ æ•°æ®é›†ç®¡ç†</h2>
    <p style="color:#666;">æ‚¨å¯ä»¥åœ¨æ­¤ä¸Šä¼ æ–°çš„å¤±æ•ˆæ—¶é—´æ•°æ®ï¼Œæˆ–ç®¡ç†å·²æœ‰çš„æ•°æ®æ–‡ä»¶ã€‚</p>
    
    <div style="margin-top: 20px; padding: 20px; border: 2px dashed #1890ff; border-radius: 8px; text-align: center; background: #f0f9ff;">
        <input type="file" id="fileInput" accept=".txt,.csv" style="display: none;" onchange="handleFileSelect()">
        <button onclick="document.getElementById('fileInput').click()" style="font-size: 16px; padding: 8px 20px;">+ ç‚¹å‡»ä¸Šä¼ æ–°æ•°æ®</button>
        <p id="fileNameDisplay" style="margin-top: 10px; color: #666;"></p>
        <button id="uploadBtn" onclick="uploadFile()" style="display: none; background-color: #52c41a; margin-top: 10px;">ç¡®è®¤ä¸Šä¼ </button>
    </div>
</div>

<div class="card" style="margin-top: 24px;">
    <h3>æˆ‘çš„æ•°æ®é›†</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background: #fafafa; border-bottom: 2px solid #eee; text-align: left;">
                <th style="padding: 12px;">ID</th>
                <th style="padding: 12px;">æ–‡ä»¶å</th>
                <th style="padding: 12px;">æ•°æ®é‡</th>
                <th style="padding: 12px;">ä¸Šä¼ æ—¶é—´</th>
                <th style="padding: 12px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="dataset-list">
            </tbody>
    </table>
</div>

<script>
    // é¡µé¢åŠ è½½æ—¶è·å–åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', loadList);

    function handleFileSelect() {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            document.getElementById('fileNameDisplay').innerText = `å·²é€‰æ–‡ä»¶: ${file.name}`;
            document.getElementById('uploadBtn').style.display = 'inline-block';
        }
    }

    function uploadFile() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/data/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('ä¸Šä¼ æˆåŠŸï¼');
                document.getElementById('fileInput').value = '';
                document.getElementById('fileNameDisplay').innerText = '';
                document.getElementById('uploadBtn').style.display = 'none';
                loadList(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
            }
        })
        .catch(err => alert('ç½‘ç»œé”™è¯¯'));
    }

    function loadList() {
        fetch('/api/data/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('dataset-list');
                tbody.innerHTML = '';
                data.data.forEach(item => {
                    tbody.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;">${item.id}</td>
                            <td style="padding: 12px;"><strong>${item.name}</strong></td>
                            <td style="padding: 12px;">${item.count} ä¸ªç‚¹</td>
                            <td style="padding: 12px; color: #888;">${item.time}</td>
                            <td style="padding: 12px;">
                                <button onclick="deleteDataset(${item.id})" style="background-color: #ff4d4f; padding: 4px 12px; font-size: 12px;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: #999;">æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ </td></tr>';
                }
            }
        });
    }

    function deleteDataset(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•°æ®é›†å—ï¼Ÿ')) return;
        fetch(`/api/data/delete/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) loadList();
            else alert(data.error);
        });
    }
</script>
{% endblock %}