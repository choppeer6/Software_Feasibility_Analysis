{% extends "base.html" %}

{% block title %}NHPP 模型分析{% endblock %}

{% block content %}
<div class="card">
    <div class="tabs">
        <div class="tab active">模型简介</div>
        <div class="tab">失效数据</div>
        <div class="tab">预测分析</div>
    </div>
    
    <div class="tab-content">
        <div id="model-intro-content" style="display: block;">
            <div class="section">
                <h3>NHPP模型简介</h3>
                <p>NHPP（Non-Homogeneous Poisson Process，非齐次泊松过程）模型是软件可靠性分析的经典方法，可根据不同的均值函数刻画故障随时间的发生规律。</p>
                
                <h4>常见模型形式</h4>
                <p>设 \( m(t) \) 为时间 \( t \) 内的期望累计失效数，\(\lambda(t)\) 为瞬时失效强度，则常见 NHPP 模型包括：</p>
                <ul>
                    <li><strong>指数型 (Goel-Okumoto):</strong> \( m(t) = a (1- e^{-b t}),\quad \lambda(t) = a b e^{-b t} \)</li>
                    <li><strong>幂律型 (Duane):</strong> \( m(t) = a t^{b},\quad \lambda(t) = a b t^{b-1} \)</li>
                    <li><strong>对数型 (Musa-Okumoto):</strong> \( m(t) = a \ln(1+b t),\quad \lambda(t) = \frac{a b}{1+b t} \)</li>
                </ul>
                
                <h4>适用场景</h4>
                <ul>
                    <li>衡量测试阶段的可靠性增长趋势</li>
                    <li>预测未来故障间隔与剩余故障数</li>
                    <li>对比不同软件版本/项目的缺陷发现效率</li>
                </ul>
                
                <h4>模型优势</h4>
                <ul>
                    <li>理论基础扎实，应用广泛</li>
                    <li>能够灵活适应不同的失效分布趋势</li>
                    <li>参数具有明确的物理意义</li>
                </ul>
            </div>
        </div>
        
        <div id="dataset-content" style="display: none;">
            <div class="dataset-section">    
                <h3>数据集配置</h3>
                <div class="form-group">
                    <label for="dataset-select">选择数据集:</label>
                    <select id="dataset-select">
                        <option value="default">默认数据集</option>
                        <option value="custom">自定义数据集</option>
                        <option value="dataset1">数据集1 (测试数据集)</option>
                        <option value="dataset2">数据集2 (项目数据集)</option>
                    </select>
                </div>
                
                <div id="custom-dataset-group" style="display: none;">
                    <div class="form-group">
                        <label for="train-data-input">输入失效数据 (用逗号分隔):</label>
                        <textarea id="train-data-input" rows="5" placeholder="例如: 9,21,32..."></textarea>
                    </div>
                    <div class="form-group">
                        <button id="load-dataset-btn">加载自定义数据</button>
                    </div>
                </div>

                <div class="slider-container" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                    <div class="slider-label" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>训练数据比例: <strong id="train-ratio-value" style="color: var(--primary-color);">70%</strong></span>
                    </div>
                    <input type="range" id="train-ratio-slider" min="10" max="90" value="70" style="width: 100%;" onchange="reloadCurrentDatasetSplit()">
                </div>
                
                <div id="dataset-preview" class="data-preview" style="margin-top: 20px; padding: 15px; background: #fafafa; border: 1px dashed #d9d9d9; border-radius: 4px; color: #666;">
                </div>
            </div>
        </div>
        
        <div id="prediction-content" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="model-type-select">模型类型:</label>
                    <select id="model-type-select">
                        <option value="exponential">指数型 (Exponential)</option>
                        <option value="power">幂律型 (Power Law)</option>
                        <option value="logarithmic">对数型 (Logarithmic)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prediction-step">预测步长:</label>
                    <input type="number" id="prediction-step" value="5" min="1" max="100">
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <button type="button" id="train-btn" style="margin-right: 15px;">仅训练模型</button>
                <button type="button" id="predict-btn" style="background-color: #52c41a;">训练并预测</button>
            </div>

            <div class="result-section" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3>分析结果</h3>
                
                <div id="message-area"></div>
                
                <div id="accuracy-metrics" class="accuracy-metrics" style="display: none;">
                    <div class="metric-card"><h4>平均绝对误差 (MAE)</h4><p id="mae-value">-</p></div>
                    <div class="metric-card"><h4>均方误差 (MSE)</h4><p id="mse-value">-</p></div>
                    <div class="metric-card"><h4>模型准确率</h4><p id="accuracy-value">-</p></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div class="chart-container" style="height: 400px;"><canvas id="reliability-chart"></canvas></div>
                    <div class="chart-container" style="height: 400px;"><canvas id="failure-chart"></canvas></div>
                </div>
                
                <div id="result-summary" style="margin-top: 20px; background: #f9f9f9; padding: 20px; border-radius: 4px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let rChart, fChart;
    let trainData = [];
    let testData = [];
    let currentDataset = [];

    const DATASETS = {
        'default': [9,21,32,36,43,45,50,58,63,70,71,77,78,87,91,92,95,103,109,110,111,144,151,242,244,245,332,379,391,400,535,793,809,844],
        'dataset1': [5, 6, 10, 15, 18, 19, 20, 26, 27, 28, 34, 50, 51, 55, 65, 71, 79, 81, 99, 109, 116, 117, 121, 133, 140, 147, 160, 171, 190, 209, 250, 273, 373],
        'dataset2': [1, 31, 37, 39, 46, 49, 67, 68, 69, 83, 84, 98, 99, 109, 126, 149, 193, 200, 205, 227, 233, 245, 246, 265, 272, 282, 301, 307, 338, 352, 369, 390, 396, 397, 403, 408, 446, 451, 455, 494, 519, 529, 574, 596, 597, 604, 641, 661, 681, 717, 739, 746, 758, 768, 774, 782, 813, 868, 875, 922, 981, 1008, 1025, 1034, 1043, 1060, 1064, 1075, 1214, 1272, 1275, 1299, 1406, 1665, 1721, 1889]
    };

    function init() {
        rChart = new Chart(document.getElementById('reliability-chart'), {
            type: 'line',
            data: { datasets: [{ label: 'Reliability', data: [], borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, min: 0, max: 1 }, x: { title: { display: true, text: 'Time' } } } }
        });
        fChart = new Chart(document.getElementById('failure-chart'), {
            type: 'scatter',
            data: { datasets: [{ label: 'Historical Failures', data: [], backgroundColor: 'rgba(75, 192, 192, 0.5)' }, { label: 'Predicted Failures', data: [], backgroundColor: 'rgba(255, 99, 132, 0.5)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Failure Sequence' } }, y: { title: { display: true, text: 'Time' } } } }
        });
    }

    function upCharts(r, h, p) {
        if (r && r.length) {
            rChart.data.labels = r.map(x => x.time);
            rChart.data.datasets[0].data = r.map(x => x.reliability);
            rChart.update();
        }
        if (h && h.length) {
            fChart.data.datasets[0].data = h.map((v, i) => ({ x: i + 1, y: v }));
            fChart.data.datasets[1].data = p ? p.map((v, i) => ({ x: i + 1 + h.length, y: v })) : [];
            fChart.update();
        }
    }

    function msg(m, t = 'info') {
        const area = document.getElementById('message-area');
        area.innerHTML = `<div class="${t}"><strong>${t === 'error' ? '错误' : t === 'success' ? '成功' : '信息'}:</strong> ${m}</div>`;
        if (t !== 'error') setTimeout(() => { area.innerHTML = ''; }, 3000);
    }

    function formatNum(value, digits = 6) {
        const n = Number(value);
        return Number.isFinite(n) ? Number(n.toFixed(digits)).toString() : 'N/A';
    }

    function formatPct(value, digits = 3) {
        const n = Number(value);
        return Number.isFinite(n) ? `${formatNum(n, digits)}%` : 'N/A';
    }

    function reloadCurrentDatasetSplit() {
        const val = document.getElementById('dataset-select').value;
        loadDS(val);
    }

    function updateDatasetPreview(d) {
        const preview = document.getElementById('dataset-preview');
        if (d && d.length > 0) {
            preview.innerHTML = `<strong>数据集预览:</strong> [${d.slice(0, 10).join(', ')}${d.length > 10 ? ', ...' : ''}] (共 ${d.length} 个数据点)<br><span style="color:green; font-size:0.9em;">(前 ${trainData.length} 个用于训练，后 ${testData.length} 个用于验证)</span>`;
        } else {
            preview.innerHTML = '';
        }
    }

    function loadDS(n) {
        if (n.startsWith('db:')) {
            const id = n.split(':')[1];
            fetch(`/api/data/get/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    processDataset(data.data, `[云端] ${data.name}`);
                } else {
                    msg('加载失败: ' + data.error, 'error');
                }
            })
            .catch(() => msg('网络错误', 'error'));
            return true;
        }

        let d;
        if (n === 'custom') {
            const input = document.getElementById('train-data-input').value;
            if (!input.trim()) return false;
            d = input.split(',').map(item => item.trim()).filter(x => x.length > 0).map(Number).filter(x => x > 0);
        } else if (n in DATASETS) {
            d = DATASETS[n];
        }

        if (!d || d.length < 4) {
            msg("无效数据 (至少需要4个点)", 'error');
            return false;
        }

        processDataset(d, n === 'custom' ? '自定义数据集' : (n === 'default' ? '默认数据集' : n));
        return true;
    }

    function processDataset(d, label) {
        currentDataset = d;
        const ratio = parseInt(document.getElementById('train-ratio-slider').value) / 100;
        const splitIdx = Math.max(3, Math.floor(d.length * ratio));
        
        trainData = d.slice(0, splitIdx);
        testData = d.slice(splitIdx);

        updateDatasetPreview(d);
        upCharts([], trainData, []);
        msg(`${label}加载成功 (训练比 ${Math.round(ratio*100)}%)`, 'success');
    }

    function train() {
        if (!trainData.length) return msg("请先加载数据", 'error');
        fetch('/api/nhpp/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ train_data: trainData, model_type: document.getElementById('model-type-select').value })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                msg("训练成功", 'success');
                document.getElementById('result-summary').innerHTML = `<h4>模型训练结果</h4><p><strong>模型类型:</strong> ${document.getElementById('model-type-select').value}</p><p><strong>训练数据点数:</strong> ${trainData.length}</p><p><strong>训练时间:</strong> ${new Date().toLocaleString()}</p>`;
            } else msg(d.error, 'error');
        });
    }

    function pred() {
        if (!trainData.length) return msg("请先加载数据", 'error');
        fetch('/api/nhpp/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data_type: document.getElementById('dataset-select').value,
                prediction_step: document.getElementById('prediction-step').value,
                model_type: document.getElementById('model-type-select').value,
                train_data: trainData,
                test_data: testData
            })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                msg("预测成功", 'success');
                document.getElementById('accuracy-metrics').style.display = 'grid';
                document.getElementById('mae-value').innerText = formatNum(d.mae, 6);
                document.getElementById('mse-value').innerText = formatNum(d.mse, 6);
                document.getElementById('accuracy-value').innerText = formatPct(d.accuracy, 3);
                
                document.getElementById('result-summary').innerHTML = `<h4>预测结果</h4><p><strong>训练数据点数:</strong> ${trainData.length}</p><p><strong>验证数据点数:</strong> ${testData.length}</p><h5>预测累积失效时间:</h5><p style="word-break: break-all;">${d.cumulative_times.map(t => formatNum(t, 2)).join(', ')}</p>`;
                
                upCharts(d.reliability_curve, trainData, d.cumulative_times);
            } else msg(d.error, 'error');
        });
    }

    function fetchDatasetList() {
        fetch('/api/data/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('dataset-select');
                const group = document.createElement('optgroup');
                group.label = "我的云端数据";
                data.data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = `db:${item.id}`;
                    opt.textContent = `[云端] ${item.name} (${item.count}点)`;
                    group.appendChild(opt);
                });
                select.appendChild(group);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        init();
        document.getElementById('dataset-select').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('custom-dataset-group').style.display = 'block';
            } else {
                document.getElementById('custom-dataset-group').style.display = 'none';
                loadDS(this.value);
            }
        });
        document.getElementById('train-ratio-slider').addEventListener('input', function() {
            document.getElementById('train-ratio-value').innerText = this.value + '%';
        });
        document.getElementById('load-dataset-btn').addEventListener('click', () => loadDS('custom'));
        document.getElementById('train-btn').addEventListener('click', train);
        document.getElementById('predict-btn').addEventListener('click', pred);
        document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
            const m = { '模型简介': 'model-intro-content', '失效数据': 'dataset-content', '预测分析': 'prediction-content' };
            Object.values(m).forEach(i => document.getElementById(i).style.display = 'none');
            document.getElementById(m[this.innerText]).style.display = 'block';
        }));
        
        loadDS('default');
        fetchDatasetList();
    });
</script>
{% endblock %}
