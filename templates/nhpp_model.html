{% extends "base.html" %}
{% block title %}NHPP 模型分析{% endblock %}
{% block content %}
<div class="card">
    <div class="tabs">
        <div class="tab active">模型简介</div>
        <div class="tab">失效数据</div>
        <div class="tab">预测分析</div>
    </div>
    
    <div class="tab-content">
        <div id="model-intro-content" style="display: block;">
            <h3>NHPP模型简介</h3>
            <p>NHPP（Non-Homogeneous Poisson Process，非齐次泊松过程）模型是软件可靠性分析的经典方法，可根据不同的均值函数刻画故障随时间的发生规律。</p>
            <h4>常见模型形式</h4>
            <p>设 \( m(t) \) 为时间 \( t \) 内的期望累计失效数，\(\lambda(t)\) 为瞬时失效强度，则常见 NHPP 模型包括：</p>
            <ul>
                <li>指数型：\( m(t) = a \bigl(1- e^{-b t}\bigr),\quad \lambda(t) = a b e^{-b t} \)</li>
                <li>幂律型：\( m(t) = a t^{b},\quad \lambda(t) = a b t^{\,b-1} \)</li>
                <li>对数型：\( m(t) = a \ln\!\bigl(1+b t\bigr),\quad \lambda(t) = \dfrac{a b}{1+b t} \)</li>
            </ul>
            <h4>适用场景</h4>
            <ul>
                <li>衡量测试阶段的可靠性增长趋势</li>
                <li>预测未来故障间隔与剩余故障数</li>
                <li>对比不同软件版本/项目的缺陷发现效率</li>
            </ul>
        </div>
        
        <div id="dataset-content" style="display: none;">
            <div class="dataset-section">    
                <h3>数据集配置</h3>
                <div class="form-group"><label>选择数据集:</label><select id="dataset-select"><option value="default">默认</option><option value="custom">自定义</option></select></div>
                <div id="custom-dataset-group" style="display: none;">
                    <div class="form-group"><label>输入数据:</label><textarea id="train-data-input" rows="5"></textarea></div>
                    <div class="slider-container"><label>训练比例 <span id="train-ratio-value">70%</span></label><input type="range" id="train-ratio-slider" min="10" max="90" value="70"></div>
                    <button id="load-dataset-btn">加载数据</button>
                </div>
                <div id="dataset-preview" class="data-preview"></div>
            </div>
        </div>
        
        <div id="prediction-content" style="display: none;">
            <form id="prediction-form">
                <div class="form-group"><label>模型类型:</label><select id="model-type-select"><option value="exponential">指数型</option><option value="power">幂律型</option><option value="logarithmic">对数型</option></select></div>
                <div class="form-group"><label>预测步长:</label><input type="number" id="prediction-step" value="5" min="1"></div>
                <button type="button" id="train-btn">训练</button>
                <button type="button" id="predict-btn" style="background:#52c41a;">预测</button>
            </form>
            <div class="result-section" style="margin-top:20px;">
                <h3>结果</h3>
                <div id="message-area"></div>
                <div id="result-summary"></div>
                <div id="accuracy-metrics" class="accuracy-metrics" style="display:none;">
                    <div class="metric-card"><h4>MAE</h4><p id="mae-value">-</p></div>
                    <div class="metric-card"><h4>MSE</h4><p id="mse-value">-</p></div>
                    <div class="metric-card"><h4>准确率</h4><p id="accuracy-value">-</p></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="chart-container" style="height:350px;"><canvas id="reliability-chart"></canvas></div>
                    <div class="chart-container" style="height:350px;"><canvas id="failure-chart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// JS 保持 NHPP 原样
let rChart, fChart, trainData=[], testData=[]; const DATASETS={'default':[9,21,32,36,43,45,50,58,63,70,71,77,78,87,91,92,95,103,109,110,111,144,151,242,244,245,332,379,391,400,535,793,809,844]};
function init(){
    rChart=new Chart(document.getElementById('reliability-chart'),{type:'line',data:{datasets:[{label:'Rel',data:[],borderColor:'blue'}]},options:{maintainAspectRatio:false}});
    fChart=new Chart(document.getElementById('failure-chart'),{type:'scatter',data:{datasets:[{label:'Hist',data:[],backgroundColor:'blue'},{label:'Pred',data:[],backgroundColor:'red'}]},options:{maintainAspectRatio:false}});
}
function upCharts(r,h,p){ if(r.length){rChart.data.labels=r.map(x=>x.time);rChart.data.datasets[0].data=r.map(x=>x.reliability);rChart.update();} if(h.length){fChart.data.datasets[0].data=h.map((v,i)=>({x:i+1,y:v})); fChart.data.datasets[1].data=p?p.map((v,i)=>({x:i+1+h.length,y:v})):[]; fChart.update();} }
function msg(m,t='info'){document.getElementById('message-area').innerHTML=`<div class="${t}">${m}</div>`;}
function loadDS(n){ let d=n==='custom'?document.getElementById('train-data-input').value.split(',').map(Number).filter(x=>x>0):DATASETS[n]; if(!d||d.length<4){msg("无效数据",'error');return false;} trainData=d; testData=[]; document.getElementById('dataset-preview').innerText=`加载: ${d.length}点`; upCharts([],trainData,[]); return true; }
function train(){ fetch('/api/nhpp/train',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({train_data:trainData,model_type:document.getElementById('model-type-select').value})}).then(r=>r.json()).then(d=>{if(d.success)msg("训练成功",'success');else msg(d.error,'error');}); }
function pred(){ fetch('/api/nhpp/predict',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data_type:'custom',prediction_step:document.getElementById('prediction-step').value,model_type:document.getElementById('model-type-select').value,train_data:trainData,test_data:testData})}).then(r=>r.json()).then(d=>{if(d.success){msg("预测成功",'success');document.getElementById('accuracy-metrics').style.display='grid';document.getElementById('mae-value').innerText=d.mae.toFixed(4);document.getElementById('accuracy-value').innerText=d.accuracy.toFixed(2)+'%'; upCharts(d.reliability_curve,trainData,d.cumulative_times);}else msg(d.error,'error');}); }
document.addEventListener('DOMContentLoaded',()=>{ init(); document.getElementById('dataset-select').addEventListener('change',function(){if(this.value==='custom')document.getElementById('custom-dataset-group').style.display='block';else{document.getElementById('custom-dataset-group').style.display='none';loadDS(this.value);}}); document.getElementById('load-dataset-btn').addEventListener('click',()=>loadDS('custom')); document.getElementById('train-btn').addEventListener('click',train); document.getElementById('predict-btn').addEventListener('click',pred); document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',function(){ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); const m={'模型简介':'model-intro-content','失效数据':'dataset-content','预测分析':'prediction-content'}; Object.values(m).forEach(i=>document.getElementById(i).style.display='none'); document.getElementById(m[this.innerText]).style.display='block'; })); loadDS('default'); });
</script>
{% endblock %}