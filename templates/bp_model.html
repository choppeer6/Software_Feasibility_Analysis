<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Neural Network Model Analysis</title>
    <style>
        /* 全局样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        /* 顶部导航栏 */
        .navbar {
            background: linear-gradient(to right, #1a73e8, #0d47a1);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            margin: 0;
            font-size: 20px;
        }
        
        /* 主容器 */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        /* 左侧菜单 */
        .sidebar {
            width: 240px;
            background-color: #0d47a1;
            color: white;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .sidebar-menu li a {
            color: inherit;
            text-decoration: none;
            display: block;
            width: 100%;
        }
        
        .sidebar-menu li:hover {
            background-color: #1a73e8;
        }
        
        .sidebar-menu li.active {
            background-color: #1a73e8;
            border-left: 4px solid #53a8ff;
        }
        
        .submenu {
            background-color: #1565c0;
            padding-left: 20px;
        }
        
        .submenu li {
            padding: 10px 15px;
        }
        
        .submenu li a {
            color: inherit;
            text-decoration: none;
            display: block;
            width: 100%;
        }
        
        /* 主内容区 */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
        }
        
        /* 标签页样式 */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: border-color 0.3s;
        }
        
        .tab.active {
            border-color: #1a73e8;
            color: #1a73e8;
            font-weight: bold;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #0d47a1;
        }
        
        /* 结果区域 */
        .result-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        /* 图表容器 */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
        
        /* 警告消息 */
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffeeba;
        }
        
        /* 错误消息 */
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        
        /* 成功消息 */
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        
        /* 准确率指标区域 */
        .accuracy-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #1a73e8;
        }
        
        .metric-card h4 {
            margin-top: 0;
            color: #1a73e8;
        }
        
        /* 加载动画 */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 数据集选择区域 */
        .dataset-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 4px;
            border-left: 4px solid #1a73e8;
        }
        
        /* 训练数据比例滑块 */
        .slider-container {
            margin: 20px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        /* 数据集描述 */
        .dataset-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* 数据预览表格 */
        .data-preview {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .accuracy-metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <p style="text-align: center; margin-top: 10px;">处理中...</p>
    </div>
    
    <!-- 顶部导航栏 -->
    <div class="navbar">
        <div class="navbar-title"><a href="/dashboard" style="color:inherit; text-decoration:none;">软件可靠性分析平台</a></div>
        <div class="navbar-user">
            <a href="/dashboard" style="color:inherit; text-decoration:underline; margin-right:15px;">Dashboard</a>
            <a href="/models" style="color:inherit; text-decoration:underline; margin-right:15px;">Models</a>
            <a href="/logout" style="color:inherit; text-decoration:underline;">Logout</a>
        </div>
    </div>
    
    <!-- 主容器 -->
    <div class="main-container">
        <!-- 左侧菜单 -->
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item"><a href="/dashboard">Dashboard</a></li>
                <li class="menu-item"><a href="/models">Models</a></li>
                <li class="menu-item">
                    经典可靠性模型
                    <ul class="submenu">
                        <li class="submenu-item"><a href="/model/jm">JM模型</a></li>
                        <li class="submenu-item"><a href="/model/go">GO模型</a></li>
                    </ul>
                </li>
                <li class="menu-item active">
                    人工智能模型
                    <ul class="submenu">
                        <li class="submenu-item active"><a href="/model/bp">BP神经网络模型</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <!-- 主内容区 -->
        <div class="content-area">
            <div class="tabs">
                <div class="tab active">模型简介</div>
                <div class="tab">失效数据</div>
                <div class="tab">预测分析</div>
            </div>
            
            <div class="tab-content">
                <!-- 模型简介内容 -->
                <div id="model-intro-content" style="display: block;">
                    <div class="section">
                        <h3>BP神经网络模型简介</h3>
                        <p>BP（Back Propagation，反向传播）神经网络是一种典型的前馈神经网络，适用于非线性函数拟合与时间序列预测。</p>
                        
                        <h4>模型特点</h4>
                        <ul>
                            <li>能够拟合复杂的非线性关系</li>
                            <li>可通过调整网络结构和超参数提升预测精度</li>
                            <li>适用于软件失效时间序列等连续数据的趋势预测</li>
                        </ul>
                        
                        <h4>本系统中的应用</h4>
                        <ul>
                            <li>根据历史失效时间序列，预测未来若干次失效时间</li>
                            <li>评估模型在验证集上的 MAE/MSE/RMSE/R² 等指标</li>
                        </ul>
                    </div>
                </div>
                
                <!-- 数据集选择区域 -->
                <div id="dataset-content" style="display: none;">
                    <div class="dataset-section">    
                        <h3>数据集选择</h3>
                        
                        <div class="form-group">
                            <label for="dataset-select">选择数据集:</label>
                            <select id="dataset-select">
                                <option value="default">默认数据集</option>
                                <option value="custom">自定义数据集</option>
                                <option value="dataset1">数据集1 (测试数据集)</option>
                                <option value="dataset2">数据集2 (项目数据集)</option>
                            </select>
                            <div class="dataset-description">
                                选择不同的数据集进行模型训练和预测
                            </div>
                        </div>
                        
                        <div id="custom-dataset-group" style="display: none;">
                            <div class="form-group">
                                <label for="train-data-input">输入失效时间数据 (用逗号分隔):</label>
                                <textarea id="train-data-input" rows="5" placeholder="例如: 9,12,32,36,43,45,50,58"></textarea>
                                <div class="dataset-description">
                                    输入失效时间数据，数据必须是正整数或正浮点数，以逗号分隔
                                </div>
                            </div>
                            
                            <div class="slider-container">
                                <div class="slider-label">
                                    <span>训练数据比例: <span id="train-ratio-value">70%</span></span>
                                </div>
                                <input type="range" id="train-ratio-slider" min="10" max="90" value="70">
                                <div class="dataset-description">
                                    设置用于模型训练的数据比例，剩余数据将用于验证（可选）
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <button id="load-dataset-btn">加载数据集</button>
                            </div>
                        </div>
                        
                        <div id="dataset-preview" class="data-preview">
                            <!-- 数据集预览将在这里显示 -->
                        </div>
                    </div>
                </div>
                
                <!-- 预测分析表单 -->
                <div id="prediction-content" style="display: none;">
                    <form id="prediction-form">
                        <div class="form-group">
                            <label for="prediction-step">预测步长:</label>
                            <input type="number" id="prediction-step" name="prediction-step" value="5" min="1" max="100">
                            <small>设置范围：1-100。设置模型向后预测的失效次数</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="look-back">滑动窗口大小 (look_back):</label>
                            <input type="number" id="look-back" name="look-back" value="5" min="1" max="20">
                            <small>设置范围：1-20。用于构造时间序列输入特征</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="hidden-size">隐含层神经元数 (hidden_size):</label>
                            <input type="number" id="hidden-size" name="hidden-size" value="10" min="1" max="50">
                            <small>设置范围：1-50。越大模型容量越强，但训练时间更长</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="lr">学习率 (lr):</label>
                            <input type="number" step="0.001" id="lr" name="lr" value="0.05" min="0.001" max="1">
                            <small>设置范围：0-1。建议 0.001 - 0.1</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="epochs">训练轮数 (epochs):</label>
                            <input type="number" id="epochs" name="epochs" value="1500" min="10" max="10000">
                            <small>设置范围：10-10000。轮数越大，拟合能力越强但耗时较长</small>
                        </div>
                        
                        <button type="button" id="train-btn">训练模型</button>
                        <button type="button" id="predict-btn">训练并预测</button>
                    </form>
    
                    <!-- 结果展示区域 -->
                    <div class="result-section">
                        <h3>预测结果</h3>
                        
                        <!-- 消息区域 -->
                        <div id="message-area">
                            <!-- 动态消息将在这里显示 -->
                        </div>
                        
                        <!-- 模型准确率指标区域 -->
                        <div id="accuracy-metrics" class="accuracy-metrics" style="display: none;">
                            <div class="metric-card">
                                <h4>平均绝对误差 (MAE)</h4>
                                <p id="mae-value">-</p>
                            </div>
                            <div class="metric-card">
                                <h4>均方误差 (MSE)</h4>
                                <p id="mse-value">-</p>
                            </div>
                            <div class="metric-card">
                                <h4>均方根误差 (RMSE)</h4>
                                <p id="rmse-value">-</p>
                            </div>
                            <div class="metric-card">
                                <h4>决定系数 (R²)</h4>
                                <p id="r2-value">-</p>
                            </div>
                            <div class="metric-card">
                                <h4>模型准确率</h4>
                                <p id="accuracy-value">-</p>
                            </div>
                        </div>
                        
                        <!-- 图表区域 -->
                        <div class="chart-container">
                            <canvas id="failure-chart"></canvas>
                        </div>
                        
                        <!-- Data result area -->
                        <div id="result-data">
                            <!-- Data table will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let failureChart;
        let currentDataset = [];
        let trainData = [];
        let testData = [];
        let modelTrained = false;
        
        // 数据集示例（可与后端 SAMPLE_FAILURE_DATA 保持风格一致）
        const DATASETS = {
            'default': [9,21,32,36,43,45,50,58,63,70,71,77,78,87,91,92,95,103,109,110,111,144,151,242,244,245,332,379,391,400,535,793,809,844],
            'dataset1': [2, 4, 6, 8, 11, 14, 17, 21, 26, 32, 39, 47, 56, 66, 77, 89],
            'dataset2': [3, 5, 7, 9, 12, 15, 18, 22, 27, 33, 40, 48, 57, 67, 78]
        };
        
        // 初始化图表
        function initCharts() {
            const failureCtx = document.getElementById('failure-chart').getContext('2d');
            failureChart = new Chart(failureCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Historical Failures',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.5)'
                    }, {
                        label: 'Predicted Failures',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Failure Sequence'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Failure Time'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新图表数据
        function updateCharts(historicalFailures, predictedFailures) {
            if (historicalFailures && historicalFailures.length > 0) {
                const historicalData = historicalFailures.map((time, index) => ({
                    x: index + 1,
                    y: time
                }));
                
                const predictedData = predictedFailures ? predictedFailures.map((time, index) => ({
                    x: index + 1 + historicalFailures.length,
                    y: time
                })) : [];
                
                failureChart.data.datasets[0].data = historicalData;
                failureChart.data.datasets[1].data = predictedData;
                failureChart.update();
            }
        }
        
        // 显示消息
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = '';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
            
            const messageType = type === 'error' ? '错误' : type === 'warning' ? '警告' : type === 'success' ? '成功' : '信息';
            messageDiv.innerHTML = `<strong>${messageType}:</strong> ${message}`;
            
            messageArea.appendChild(messageDiv);
            
            if (type !== 'error') {
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
        }
        
        // 解析自定义数据集
        function parseCustomDataset() {
            const input = document.getElementById('train-data-input').value.trim();
            if (!input) {
                showMessage("请输入失效时间数据", 'error');
                return null;
            }
            
            try {
                const numbers = input.split(',')
                    .map(item => item.trim())
                    .filter(item => item.length > 0)
                    .map(item => {
                        const num = parseFloat(item);
                        if (isNaN(num) || num <= 0) {
                            throw new Error(`无效的数值: ${item}`);
                        }
                        return num;
                    });
                
                if (numbers.length < 6) {
                    throw new Error("BP 模型建议至少提供 6 个以上失效时间点");
                }
                
                return numbers;
            } catch (error) {
                showMessage(error.message, 'error');
                return null;
            }
        }
        
        // 分割训练和测试数据
        function splitTrainTestData(dataset, ratio) {
            const splitIndex = Math.floor(dataset.length * ratio / 100);
            return {
                train: dataset.slice(0, splitIndex),
                test: dataset.slice(splitIndex)
            };
        }
        
        // 更新数据集预览
        function updateDatasetPreview(dataset) {
            const preview = document.getElementById('dataset-preview');
            if (dataset.length > 0) {
                preview.innerHTML = `<strong>数据集预览:</strong> [${dataset.slice(0, 10).join(', ')}${dataset.length > 10 ? ', ...' : ''}] (共 ${dataset.length} 个数据点)`;
            } else {
                preview.innerHTML = '';
            }
        }
        
        // 加载数据集
        function loadDataset(datasetName) {
            try {
                let dataset;
                
                if (datasetName === 'custom') {
                    dataset = parseCustomDataset();
                    if (!dataset) return false;
                } else if (datasetName in DATASETS) {
                    dataset = DATASETS[datasetName];
                } else {
                    showMessage(`未知的数据集: ${datasetName}`, 'error');
                    return false;
                }
                
                currentDataset = dataset;
                
                if (datasetName === 'custom') {
                    const ratio = parseInt(document.getElementById('train-ratio-slider').value);
                    const splitResult = splitTrainTestData(dataset, ratio);
                    trainData = splitResult.train;
                    testData = splitResult.test;
                    showMessage(`自定义数据集加载成功，训练数据: ${trainData.length} 个, 测试数据: ${testData.length} 个`, 'success');
                } else {
                    trainData = dataset;
                    testData = [];
                    showMessage(`${datasetName === 'default' ? '默认数据集' : datasetName}加载成功，共 ${dataset.length} 个数据点`, 'success');
                }
                
                updateDatasetPreview(dataset);
                modelTrained = false;
                
                updateCharts(trainData, []);
                return true;
            } catch (error) {
                showMessage(`加载数据集失败: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 训练模型（仅调用后端训练接口以返回最终 loss，用于调参）
        function trainModelOnly() {
            if (trainData.length === 0) {
                showMessage("请先加载数据集", 'error');
                return;
            }
            
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.style.display = 'block';
            
            try {
                const lookBack = parseInt(document.getElementById('look-back').value);
                const hiddenSize = parseInt(document.getElementById('hidden-size').value);
                const lr = parseFloat(document.getElementById('lr').value);
                const epochs = parseInt(document.getElementById('epochs').value);
                
                fetch('/api/bp/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        train_data: trainData,
                        look_back: lookBack,
                        hidden_size: hiddenSize,
                        lr: lr,
                        epochs: epochs
                    }),
                })
                .then(response => {
                    loadingSpinner.style.display = 'none';
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP错误: ${response.status} - ${text}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(responseData => {
                    if (!responseData) {
                        throw new Error("服务器返回空响应");
                    }
                    
                    if (responseData.success) {
                        modelTrained = true;
                        showMessage(`模型训练成功，最终损失: ${responseData.final_loss.toFixed(6)}`, 'success');
                        
                        const resultDiv = document.getElementById('result-data');
                        resultDiv.innerHTML = `
                            <h4>模型训练结果</h4>
                            <p><strong>训练数据点数:</strong> ${responseData.used_train_count || trainData.length}</p>
                            <p><strong>损失函数最终值:</strong> ${responseData.final_loss.toFixed(6)}</p>
                        `;
                    } else {
                        throw new Error(responseData.error || "模型训练失败");
                    }
                })
                .catch(error => {
                    showMessage(`训练模型失败: ${error.message}`, 'error');
                });
                
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showMessage(`训练模型失败: ${error.message}`, 'error');
            }
        }
        
        // 训练并预测
        function trainAndPredict() {
            if (trainData.length === 0) {
                showMessage("请先加载数据集", 'error');
                return;
            }
            
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.style.display = 'block';
            
            try {
                const predictionStep = parseInt(document.getElementById('prediction-step').value);
                const lookBack = parseInt(document.getElementById('look-back').value);
                const hiddenSize = parseInt(document.getElementById('hidden-size').value);
                const lr = parseFloat(document.getElementById('lr').value);
                const epochs = parseInt(document.getElementById('epochs').value);
                
                if (isNaN(predictionStep) || predictionStep < 1 || predictionStep > 100) {
                    throw new Error("预测步长必须是1-100之间的整数");
                }
                
                const formData = {
                    data_type: document.getElementById('dataset-select').value,
                    prediction_step: predictionStep,
                    look_back: lookBack,
                    hidden_size: hiddenSize,
                    lr: lr,
                    epochs: epochs,
                    train_data: trainData,
                    test_data: testData
                };
                
                fetch('/api/bp/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                })
                .then(response => {
                    loadingSpinner.style.display = 'none';
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP错误: ${response.status} - ${text}`);
                        });
                    }
                    
                    return response.json();
                })
                .then(responseData => {
                    if (!responseData) {
                        throw new Error("服务器返回空响应");
                    }
                    
                    if (responseData.success) {
                        modelTrained = true;
                        showMessage("预测成功完成", 'success');
                        updatePredictionResults(responseData);
                    } else {
                        throw new Error(responseData.error || "预测失败");
                    }
                })
                .catch(error => {
                    showMessage(`预测失败: ${error.message}`, 'error');
                });
                
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showMessage(error.message, 'error');
            }
        }
        
        // 更新预测结果
        function updatePredictionResults(data) {
            const accuracyMetrics = document.getElementById('accuracy-metrics');
            accuracyMetrics.style.display = 'grid';
            
            document.getElementById('mae-value').textContent = data.mae !== undefined ? `${data.mae}` : 'N/A';
            document.getElementById('mse-value').textContent = data.mse !== undefined ? `${data.mse}` : 'N/A';
            document.getElementById('rmse-value').textContent = data.rmse !== undefined ? `${data.rmse}` : 'N/A';
            document.getElementById('r2-value').textContent = data.r2_score !== undefined ? `${data.r2_score}` : 'N/A';
            document.getElementById('accuracy-value').textContent = data.accuracy !== undefined ? `${data.accuracy}%` : 'N/A';
            
            const resultDiv = document.getElementById('result-data');
            resultDiv.innerHTML = `
                <h4>预测结果</h4>
                <p><strong>下一次失效预测时间:</strong> ${data.next_failure_time !== undefined ? data.next_failure_time : 'N/A'}</p>
                <h5>未来失效时间预测点:</h5>
                <ul>
                    ${data.predicted_times && data.predicted_times.length > 0 ? 
                        data.predicted_times.map((t, i) => `<li>第${i+1}次: ${t}</li>`).join('') : 
                        '<li>无预测数据</li>'}
                </ul>
            `;
            
            updateCharts(
                currentDataset.length > 0 ? currentDataset : trainData,
                data.predicted_times || []
            );
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            
            document.getElementById('dataset-select').addEventListener('change', function() {
                const customGroup = document.getElementById('custom-dataset-group');
                if (this.value === 'custom') {
                    customGroup.style.display = 'block';
                } else {
                    customGroup.style.display = 'none';
                    loadDataset(this.value);
                }
            });
            
            document.getElementById('train-ratio-slider').addEventListener('input', function() {
                document.getElementById('train-ratio-value').textContent = `${this.value}%`;
            });
            
            document.getElementById('load-dataset-btn').addEventListener('click', function() {
                loadDataset('custom');
            });
            
            document.getElementById('train-btn').addEventListener('click', function() {
                trainModelOnly();
            });
            
            document.getElementById('predict-btn').addEventListener('click', function() {
                trainAndPredict();
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabContents = {
                        '模型简介': document.getElementById('model-intro-content'),
                        '失效数据': document.getElementById('dataset-content'),
                        '预测分析': document.getElementById('prediction-content')
                    };
                    
                    Object.values(tabContents).forEach(content => {
                        if (content) content.style.display = 'none';
                    });
                    
                    const tabName = this.textContent.trim();
                    if (tabContents[tabName]) {
                        tabContents[tabName].style.display = 'block';
                    }
                });
            });
            
            // 默认选中第一个标签
            document.querySelectorAll('.tab')[0].click();
            // 初始加载默认数据集
            loadDataset('default');
        });
    </script>
</body>
</html>


